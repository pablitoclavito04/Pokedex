<!-- ============================================================================
     SETTINGS PAGE - Página de edición de perfil

     Secciones:
     - Header con título y botón cerrar
     - Foto de perfil
     - Nombre de usuario
     - Nombre
     - Descripción corta
     - Género
     - Región favorita
     - Zona de peligro (eliminar cuenta)
     - Botones Cancelar/Guardar
     ============================================================================ -->

<main class="settings-page">
  <div class="settings-page__container">

    <!-- ========== HEADER ========== -->
    <header class="settings-page__header">
      <h1 class="settings-page__title">Editar perfil</h1>
      <button class="settings-page__close-btn" (click)="close()" aria-label="Cerrar">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </header>

    <!-- ========== CONTENIDO ========== -->
    <div class="settings-page__content">

      <!-- Foto de perfil -->
      <section class="settings-field">
        <label class="settings-field__label">Foto de perfil</label>
        <input
          type="file"
          #fileInput
          class="settings-field__file-input"
          accept="image/*"
          (change)="onFileSelected($event)">
        <div class="settings-field__avatar-wrapper">
          <div class="settings-field__avatar" (click)="onAvatarClick()">
            @if (profileData.avatar) {
              <img [src]="profileData.avatar" alt="Foto de perfil" class="settings-field__avatar-img">
            } @else {
              <svg class="settings-field__avatar-placeholder" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            }
          </div>
          <button class="settings-field__avatar-edit" (click)="onAvatarClick()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Nombre de usuario -->
      <section class="settings-field">
        <label class="settings-field__label" for="username">Nombre de usuario</label>
        <div class="settings-field__input-wrapper">
          <input
            type="text"
            id="username"
            class="settings-field__input"
            [class.settings-field__input--error]="usernameError"
            [(ngModel)]="profileData.username"
            (ngModelChange)="onUsernameChange($event)"
            placeholder="nombre_de_usuario"
            [maxlength]="usernameMaxLength">
        </div>
        <p class="settings-field__hint" [class.settings-field__hint--error]="usernameError">
          @if (usernameError) {
            {{ usernameError }}
          } @else {
            Solo letras, números, guiones bajos y puntos. Máximo {{ usernameMaxLength }} caracteres.
          }
        </p>
        <p class="settings-field__counter">{{ profileData.username.length }}/{{ usernameMaxLength }}</p>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Contraseña -->
      <section class="settings-field">
        <label class="settings-field__label" for="currentPassword">Contraseña actual</label>
        <div class="settings-field__input-wrapper settings-field__input-wrapper--password">
          <input
            [type]="showCurrentPassword ? 'text' : 'password'"
            id="currentPassword"
            class="settings-field__input settings-field__input--password settings-field__input--readonly"
            [value]="passwordData.currentPassword"
            readonly
            placeholder="Contraseña actual">
          <button
            type="button"
            class="settings-field__toggle-password"
            (click)="toggleCurrentPasswordVisibility()">
            <svg *ngIf="!showCurrentPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg *ngIf="showCurrentPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Nueva contraseña -->
      <section class="settings-field settings-field--new-password">
        <label class="settings-field__label" for="newPassword">Nueva contraseña</label>
        <div class="settings-field__input-wrapper settings-field__input-wrapper--password">
          <input
            [type]="showNewPassword ? 'text' : 'password'"
            id="newPassword"
            class="settings-field__input settings-field__input--password"
            [(ngModel)]="passwordData.newPassword"
            (ngModelChange)="onPasswordChange()"
            placeholder="Nueva contraseña">
          <button
            type="button"
            class="settings-field__toggle-password"
            (click)="toggleNewPasswordVisibility()">
            <svg *ngIf="!showNewPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <svg *ngIf="showNewPassword" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          </button>
        </div>
        <!-- Requisitos de contraseña -->
        <div class="settings-field__password-requirements">
          <div class="settings-field__requirement" [class.settings-field__requirement--valid]="passwordValidation.length">
            <svg viewBox="0 0 24 24" fill="currentColor">
              @if (passwordValidation.length) {
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              } @else {
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
              }
            </svg>
            <span>De 8 a 50 caracteres</span>
          </div>
          <div class="settings-field__requirement" [class.settings-field__requirement--valid]="passwordValidation.hasNumber">
            <svg viewBox="0 0 24 24" fill="currentColor">
              @if (passwordValidation.hasNumber) {
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              } @else {
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
              }
            </svg>
            <span>Un número</span>
          </div>
          <div class="settings-field__requirement" [class.settings-field__requirement--valid]="passwordValidation.hasUppercase">
            <svg viewBox="0 0 24 24" fill="currentColor">
              @if (passwordValidation.hasUppercase) {
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              } @else {
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
              }
            </svg>
            <span>Una letra mayúscula</span>
          </div>
          <div class="settings-field__requirement" [class.settings-field__requirement--valid]="passwordValidation.hasSpecial">
            <svg viewBox="0 0 24 24" fill="currentColor">
              @if (passwordValidation.hasSpecial) {
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              } @else {
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
              }
            </svg>
            <span>Un carácter especial (!, &amp;, %, etc.)</span>
          </div>
          <div class="settings-field__requirement" [class.settings-field__requirement--valid]="passwordValidation.hasLowercase">
            <svg viewBox="0 0 24 24" fill="currentColor">
              @if (passwordValidation.hasLowercase) {
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              } @else {
                <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
              }
            </svg>
            <span>Una letra minúscula</span>
          </div>
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Nombre -->
      <section class="settings-field">
        <label class="settings-field__label" for="displayName">Nombre</label>
        <div class="settings-field__input-wrapper">
          <input
            type="text"
            id="displayName"
            class="settings-field__input"
            [(ngModel)]="profileData.displayName"
            (ngModelChange)="onFieldChange()"
            placeholder="Tu nombre"
            [maxlength]="displayNameMaxLength">
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Descripción corta -->
      <section class="settings-field">
        <label class="settings-field__label" for="bio">Descripción corta</label>
        <div class="settings-field__input-wrapper">
          <textarea
            id="bio"
            class="settings-field__textarea"
            [(ngModel)]="profileData.bio"
            (ngModelChange)="onFieldChange()"
            placeholder="Escribe algo sobre ti..."
            [maxlength]="bioMaxLength"
            rows="3">
          </textarea>
        </div>
        <p class="settings-field__counter">{{ bioLength }}/{{ bioMaxLength }}</p>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Género -->
      <section class="settings-field">
        <label class="settings-field__label" for="gender">Género</label>
        <div class="settings-field__select-wrapper">
          <select
            id="gender"
            class="settings-field__select"
            [(ngModel)]="profileData.gender"
            (ngModelChange)="onFieldChange()"
            (click)="onSelectClick('gender')"
            (blur)="onSelectBlur('gender')">
            @for (option of genderOptions; track option) {
              <option [value]="option">{{ option }}</option>
            }
          </select>
          <span class="settings-field__select-icon" [class.settings-field__select-icon--open]="selectStates['gender']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Región favorita -->
      <section class="settings-field">
        <label class="settings-field__label" for="favoriteRegion">Región favorita</label>
        <div class="settings-field__select-wrapper">
          <select
            id="favoriteRegion"
            class="settings-field__select"
            [(ngModel)]="profileData.favoriteRegion"
            (ngModelChange)="onFieldChange()"
            (click)="onSelectClick('favoriteRegion')"
            (blur)="onSelectBlur('favoriteRegion')">
            @for (region of regionOptions; track region) {
              <option [value]="region">{{ region }}</option>
            }
          </select>
          <span class="settings-field__select-icon" [class.settings-field__select-icon--open]="selectStates['favoriteRegion']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </span>
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Preferencias -->
      <section class="settings-preferences">
        <h2 class="settings-preferences__title">Preferencias</h2>

        <!-- Idioma -->
        <div class="settings-field">
          <label class="settings-field__label" for="language">Idioma</label>
          <div class="settings-field__select-wrapper">
            <select
              id="language"
              class="settings-field__select"
              [(ngModel)]="profileData.language"
              (ngModelChange)="onFieldChange()"
              (click)="onSelectClick('language')"
              (blur)="onSelectBlur('language')">
              @for (lang of languageOptions; track lang) {
                <option [value]="lang">{{ lang }}</option>
              }
            </select>
            <span class="settings-field__select-icon" [class.settings-field__select-icon--open]="selectStates['language']">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </span>
          </div>
        </div>
      </section>

      <div class="settings-page__divider"></div>

      <!-- Zona de peligro -->
      <section class="settings-danger">
        <h2 class="settings-danger__title">Zona de peligro</h2>
        <p class="settings-danger__text">
          Esta acción no se puede deshacer. Se eliminarán todos los datos.
        </p>
        <button class="settings-danger__btn" (click)="deleteAccount()">
          Eliminar cuenta
        </button>
      </section>

    </div>

    <!-- ========== FOOTER CON BOTONES ========== -->
    <footer class="settings-page__footer">
      <button class="settings-page__btn settings-page__btn--cancel" (click)="cancel()">
        Cancelar
      </button>
      <button
        class="settings-page__btn settings-page__btn--save"
        [class.settings-page__btn--disabled]="!canSave"
        [disabled]="!canSave"
        (click)="saveChanges()">
        Guardar
      </button>
    </footer>

  </div>

  <!-- ========== MODAL DE CONFIRMACIÓN ELIMINAR CUENTA ========== -->
  @if (showDeleteModal) {
    <div class="settings-page__modal-overlay" (click)="closeDeleteModal()">
      <div class="settings-page__modal" (click)="$event.stopPropagation()">
        <p class="settings-page__modal-text">
          ¿Estás seguro?<br>
          No podrás recuperar tus datos después de eliminar tu cuenta.
        </p>
        <div class="settings-page__modal-actions">
          <button class="settings-page__modal-btn settings-page__modal-btn--delete" (click)="confirmDeleteAccount()">
            Sí, eliminar
          </button>
          <button class="settings-page__modal-btn settings-page__modal-btn--cancel" (click)="closeDeleteModal()">
            Mejor lo pienso
          </button>
        </div>
      </div>
    </div>
  }

</main>
