<!-- ============================================================================
     POKEDEX PAGE - Página principal de la Pokédex

     Secciones:
     - Búsqueda rápida
     - Grid de Pokémon
     - Botón cargar más
     ============================================================================ -->

<main class="pokedex-page">

  <!-- ========== BÚSQUEDA RÁPIDA ========== -->
  <section class="search-section">
    <div class="search-section__container">
      <h1 class="search-section__title">Búsqueda rápida</h1>
      <p class="search-section__description">
        Busca un Pokémon por su nombre o usando su número de la Pokédex nacional
      </p>

      <!-- Barra de búsqueda -->
      <div class="search-section__input-wrapper">
        <label for="pokemon-search" class="sr-only">Buscar Pokémon por nombre o número</label>
        <svg class="search-section__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input
          #searchInput
          id="pokemon-search"
          type="text"
          class="search-section__input"
          placeholder="Nombre o número"
          [(ngModel)]="searchQuery"
          (input)="onSearchInput($event)"
          (keydown)="onSearchKeydown($event)"
          (keyup)="onSearchKeyup($event)"
          (focus)="onSearchFocus()"
          (blur)="onSearchBlur()">

        <!-- Historial de búsqueda -->
        @if (showSearchHistory && searchHistory.length > 0) {
          <div class="search-history" role="listbox" aria-label="Historial de búsqueda">
            <ul class="search-history__list" role="presentation">
              @for (item of searchHistory; track item) {
                <li class="search-history__item" (mousedown)="selectHistoryItem(item)">
                  <svg class="search-history__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  <span class="search-history__text">{{ item }}</span>
                </li>
              }
            </ul>
          </div>
        }
      </div>

      <p class="search-section__hint">
        Usa la búsqueda avanzada para encontrar Pokémons por su tipo, generación, peso, etc...
      </p>
    </div>
  </section>

  <!-- ========== BÚSQUEDA AVANZADA ========== -->
  @if (showAdvancedSearch) {
    <section
      class="advanced-search"
      [class.advanced-search--closing]="isAdvancedSearchClosing">
      <div class="advanced-search__container">

        <!-- Columna izquierda: Por tipo y Generación -->
        <div class="advanced-search__column">
          <div class="advanced-search__header">
            <h3 class="advanced-search__title">Por tipo</h3>
          </div>

          <div class="advanced-search__types-grid">
            @for (type of advancedTypes; track type.value) {
              <button
                class="type-filter__badge"
                [class.type-filter__badge--active]="type.typeSelected"
                [style.background-color]="type.color"
                [attr.aria-pressed]="type.typeSelected"
                (click)="toggleTypeFilter(type.value, 'type')">
                {{ type.name }}
              </button>
            }
          </div>

          <!-- Generación -->
          <div class="advanced-search__section advanced-search__section--generation">
            <label for="generation-select" class="advanced-search__title" id="generation-label">Generación</label>
            <div class="advanced-search__select-wrapper">
              <select
                id="generation-select"
                class="advanced-search__select"
                [(ngModel)]="selectedGeneration"
                (click)="toggleGenerationSelect()"
                (blur)="closeGenerationSelect()"
                (keydown.arrowdown)="onGenerationArrowDown($event)"
                (keydown.arrowup)="onGenerationArrowUp($event)"
                (change)="onGenerationChange($event)"
                aria-labelledby="generation-label">
                <option value="all">Todas</option>
                @for (gen of generations; track gen.value) {
                  @if (gen.value !== 'all') {
                    <option [value]="gen.value">{{ gen.name }}</option>
                  }
                }
              </select>
              <span class="advanced-search__select-arrow-wrapper" [class.advanced-search__select-arrow-wrapper--open]="isGenerationSelectOpen" aria-hidden="true">
                <svg class="advanced-search__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </span>
            </div>
          </div>
        </div>

        <!-- Columna derecha: Altura, Peso -->
        <div class="advanced-search__column">

          <!-- Altura -->
          <div class="advanced-search__section">
            <h3 class="advanced-search__title">Altura</h3>
            <div class="advanced-search__options">
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedHeight === 'small'"
                (click)="selectHeight('small')">
                <img src="/Pokedex/silueta de pokemon pequeño.png" alt="Pequeño" style="width: 32px; height: 32px;">
              </button>
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedHeight === 'medium'"
                (click)="selectHeight('medium')">
                <img src="/Pokedex/silueta dragonair.png" alt="Mediano" style="width: 48px; height: 48px;">
              </button>
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedHeight === 'large'"
                (click)="selectHeight('large')">
                <img src="/Pokedex/silueta rayquaza.png" alt="Grande" style="width: 70px; height: 70px;">
              </button>
            </div>
          </div>

          <!-- Peso -->
          <div class="advanced-search__section">
            <h3 class="advanced-search__title">Peso</h3>
            <div class="advanced-search__options advanced-search__options--weight">
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedWeight === 'light'"
                (click)="selectWeight('light')">
                <img src="/Pokedex/silueta de peso bajo.png" alt="Ligero" style="width: 32px; height: 32px;">
              </button>
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedWeight === 'medium'"
                (click)="selectWeight('medium')">
                <img src="/Pokedex/silueta de peso mediano.png" alt="Mediano" style="width: 48px; height: 48px;">
              </button>
              <button
                class="advanced-search__option-btn"
                [class.advanced-search__option-btn--active]="selectedWeight === 'heavy'"
                (click)="selectWeight('heavy')">
                <img src="/Pokedex/silueta de peso pesado.png" alt="Pesado" style="width: 60px; height: 60px;">
              </button>
            </div>
          </div>

          <!-- Secuencia -->
          <div class="advanced-search__section">
            <h3 class="advanced-search__title" id="sequence-title">Secuencia</h3>
            <div class="advanced-search__sequence-inputs">
              <label for="sequence-start" class="sr-only">Número inicial de secuencia</label>
              <input
                id="sequence-start"
                type="number"
                class="advanced-search__sequence-input"
                [(ngModel)]="sequenceStart"
                min="1"
                max="1025"
                aria-describedby="sequence-title">
              <span class="advanced-search__sequence-separator" aria-hidden="true">-</span>
              <label for="sequence-end" class="sr-only">Número final de secuencia</label>
              <input
                id="sequence-end"
                type="number"
                class="advanced-search__sequence-input"
                [(ngModel)]="sequenceEnd"
                min="1"
                max="1025"
                aria-describedby="sequence-title">
            </div>
          </div>

        </div>

      </div>

      <!-- Botones de acción -->
      <div class="advanced-search__footer">
        <div class="advanced-search__actions">
          <button class="advanced-search__reset-btn" (click)="resetFilters()" aria-label="Restablecer todos los filtros">
            Restablecer
          </button>
          <button class="advanced-search__search-btn" (click)="applyFilters()" aria-label="Aplicar filtros de búsqueda">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            Buscar
          </button>
        </div>
      </div>

    </section>
  }

  <!-- ========== BÚSQUEDA AVANZADA TOGGLE ========== -->
  <section class="advanced-search-toggle">
    <button class="advanced-search-toggle__btn" (click)="toggleAdvancedSearch()" [attr.aria-expanded]="isAdvancedSearchOpen">
      {{ isAdvancedSearchOpen ? 'Ocultar búsqueda avanzada' : 'Mostrar búsqueda avanzada' }}
      <span class="advanced-search-toggle__icon-wrapper" [class.advanced-search-toggle__icon-wrapper--open]="isAdvancedSearchOpen" aria-hidden="true">
        <svg
          class="advanced-search-toggle__icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
      </span>
    </button>
  </section>

  <!-- ========== BARRA DE ACCIONES ========== -->
  <section class="actions-bar">
    <div class="actions-bar__container">
      <button class="actions-bar__surprise-btn" (click)="onSurprise()" aria-label="Mostrar un Pokémon aleatorio">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M23 4v6h-6"/>
          <path d="M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
        ¡Sorpréndeme!
      </button>

      <div class="actions-bar__sort">
        <label for="sort-order" class="actions-bar__sort-label" id="sort-label">Ordenar por</label>
        <div class="actions-bar__select-wrapper">
          <svg class="actions-bar__select-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="3"/>
            <line x1="2" y1="12" x2="9" y2="12"/>
            <line x1="15" y1="12" x2="22" y2="12"/>
          </svg>
          <select id="sort-order" class="actions-bar__select" [(ngModel)]="sortOrder" (change)="onSortChange()" aria-labelledby="sort-label">
            <option value="number-asc">Número inferior</option>
            <option value="number-desc">Número superior</option>
            <option value="name-asc">A - Z</option>
            <option value="name-desc">Z - A</option>
          </select>
          <span class="actions-bar__select-arrow-wrapper" aria-hidden="true">
            <svg class="actions-bar__select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== GRID DE POKÉMON ========== -->
  <section class="pokemon-grid-section">
    <div class="pokemon-grid-section__container">

      <!-- Loading -->
      @if (isLoading && pokemons.length === 0) {
        <div class="pokemon-grid-section__loading">
          <p>Cargando Pokémon...</p>
        </div>
      }

      <!-- No results -->
      @if (!isLoading && pokemons.length === 0) {
        <div class="pokemon-grid-section__no-results">
          <p>Este Pokémon no existe</p>
        </div>
      }

      <div class="pokemon-grid">
        @for (pokemon of pokemons; track pokemon.id) {
          <article
            class="pokemon-card"
            [class.pokemon-card--hovered]="hoveredPokemonId === pokemon.id"
            (click)="goToPokemonDetail(pokemon.id)"
            (mouseenter)="onCardMouseEnter($event, pokemon.id)"
            (mouseleave)="onCardMouseLeave($event, pokemon.id)">

            <!-- Botón de favorito (solo visible para usuarios logueados) -->
            @if (isLoggedIn) {
              <button
                class="pokemon-card__favorite"
                [class.pokemon-card__favorite--active]="pokemon.isFavorite"
                (click)="toggleFavorite($event, pokemon.id)"
                [attr.aria-label]="pokemon.isFavorite ? 'Quitar ' + pokemon.name + ' de favoritos' : 'Añadir ' + pokemon.name + ' a favoritos'"
                [attr.aria-pressed]="pokemon.isFavorite">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </button>
            }

            <!-- Contenedor de imagen con fondo -->
            <div class="pokemon-card__image-container">
              <img
                [src]="pokemon.image"
                [alt]="pokemon.name"
                class="pokemon-card__image"
                loading="lazy">
            </div>

            <!-- Nombre -->
            <h3 class="pokemon-card__name">{{ pokemon.name }}</h3>

            <!-- Número pequeño -->
            <span class="pokemon-card__number">{{ formatPokemonId(pokemon.id) }}</span>

            <!-- Tipos -->
            <div class="pokemon-card__types">
              @for (type of pokemon.types; track type) {
                <span
                  class="pokemon-card__type"
                  [style.background-color]="getTypeColor(type)">
                  {{ getTypeName(type) }}
                </span>
              }
            </div>

            <!-- Botón más información -->
            <!-- PROPAGACIÓN: stopPropagation() evita doble navegación (botón + tarjeta) -->
            <button class="pokemon-card__btn" (click)="goToPokemonDetail(pokemon.id); $event.stopPropagation()" [attr.aria-label]="'Ver más información de ' + pokemon.name">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="3"/>
                <line x1="2" y1="12" x2="9" y2="12"/>
                <line x1="15" y1="12" x2="22" y2="12"/>
              </svg>
              Más información
            </button>

          </article>
        }
      </div>

      <!-- Botón cargar más -->
      @if (hasMorePokemon) {
        <div class="pokemon-grid-section__load-more">
          <button class="load-more-btn" (click)="loadMorePokemon()" [disabled]="isLoading">
            @if (isLoading) {
              Cargando...
            } @else {
              Cargar más Pokémon
            }
          </button>
        </div>
      }

    </div>
  </section>

</main>